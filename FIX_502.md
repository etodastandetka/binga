# Исправление 502 Bad Gateway

## Быстрое исправление:

```bash
# 1. Проверить статус PM2
pm2 status

# 2. Проверить логи на ошибки (ОБЯЗАТЕЛЬНО если статус "errored"!)
pm2 logs bingo-admin --lines 100 --err

# 3. Если bingo-admin не запущен или упал:
cd /var/www/bingo/admin_nextjs
pm2 restart bingo-admin

# 4. Если не помогло, перезапустить полностью:
pm2 stop bingo-admin
pm2 delete bingo-admin

# 5. Проверить что build выполнен
ls .next/standalone/server.js
# Если файла нет - выполнить build (см. раздел ниже)

# 6. Запустить заново
cd /var/www/bingo/admin_nextjs
pm2 start "NODE_ENV=production PORT=3002 node .next/standalone/server.js" --name bingo-admin
pm2 save

# 7. Подождать 2-3 секунды и проверить статус
sleep 3
pm2 status

# 8. Проверить что работает:
curl http://127.0.0.1:3002/api/public/payment-settings

# 9. Перезагрузить nginx:
sudo systemctl reload nginx
```

## КРИТИЧНО: Ошибка "Couldn't find any 'pages' or 'app' directory"

**Если видите ошибку:** `Error: > Couldn't find any 'pages' or 'app' directory. Please create one under the project root`

**Причина:** На сервере отсутствует директория `app` с кодом приложения

**Решение:**
```bash
cd /var/www/bingo/admin_nextjs

# 1. Проверить структуру проекта
ls -la
# Должна быть директория "app"
ls -la app/
# Должны быть файлы: layout.tsx, page.tsx, и т.д.

# 2. Если директории app нет - проверить git статус
git status
git log --oneline -5

# 3. Убедиться что мы в правильной ветке
git branch
# Должно быть: * chore-update-admin-15325 или main

# 4. Если файлов нет - сделать полный pull
git fetch origin
git reset --hard origin/chore-update-admin-15325
# ВНИМАНИЕ: Это удалит локальные изменения!

# 5. Проверить что файлы появились
ls -la app/
ls -la app/api/
ls -la app/dashboard/

# 6. Теперь выполнить build
npm run build

# 7. Проверить что build успешен
ls -la .next/standalone/server.js
```

## КРИТИЧНО: Ошибка "Cannot find module server.js"

**Если видите ошибку:** `Error: Cannot find module '/var/www/bingo/admin_nextjs/.next/standalone/server.js'`

**Решение:**
```bash
cd /var/www/bingo/admin_nextjs

# 1. Проверить что мы в правильной директории
pwd
ls package.json

# 2. Выполнить build (ОБЯЗАТЕЛЬНО!)
npm run build

# 3. Дождаться завершения build (может занять 2-5 минут)
# Должно появиться "Compiled successfully"

# 4. Проверить что файл создан
ls -la .next/standalone/server.js
# Должен существовать!

# 5. Скопировать статические файлы (КРИТИЧНО!)
mkdir -p .next/standalone/.next
cp -r .next/static .next/standalone/.next/static
cp -r .next/BUILD_ID .next/standalone/.next/BUILD_ID 2>/dev/null || true

# 6. Проверить что все файлы на месте
ls -la .next/standalone/server.js
ls -la .next/standalone/.next/static

# 7. Теперь запустить PM2
pm2 stop bingo-admin 2>/dev/null || true
pm2 delete bingo-admin 2>/dev/null || true
pm2 start "NODE_ENV=production PORT=3002 node .next/standalone/server.js" --name bingo-admin
pm2 save

# 8. Проверить статус
pm2 status
pm2 logs bingo-admin --lines 50
```

## Если приложение не запускается (статус "errored" или не отвечает на порту):

```bash
cd /var/www/bingo/admin_nextjs

# 1. Проверить логи PM2 на ошибки (ВАЖНО!)
pm2 logs bingo-admin --lines 100 --err
pm2 logs bingo-admin --lines 100

# 2. Проверить что build выполнен и файлы существуют
ls -la .next/standalone/server.js
ls -la .next/standalone/.next/static

# 3. Если файлов нет - выполнить build:
npm run build
mkdir -p .next/standalone/.next
cp -r .next/static .next/standalone/.next/static
cp -r .next/BUILD_ID .next/standalone/.next/BUILD_ID 2>/dev/null || true

# 4. Попробовать запустить вручную чтобы увидеть ошибки:
cd /var/www/bingo/admin_nextjs
NODE_ENV=production PORT=3002 node .next/standalone/server.js
# Если есть ошибки, они будут видны в консоли
# Нажмите Ctrl+C чтобы остановить

# 5. Проверить переменные окружения
pm2 env bingo-admin | grep -E "PORT|NODE_ENV|DATABASE_URL"

# 6. Проверить что порт свободен
netstat -tulpn | grep 3002
# Если порт занят другим процессом, нужно его остановить
```

## Проверка nginx:

```bash
# Проверить конфигурацию
sudo nginx -t

# Проверить что nginx проксирует на правильный порт
sudo grep -A 5 "proxy_pass" /etc/nginx/sites-enabled/* | grep 3002

# Перезагрузить nginx
sudo systemctl reload nginx

# Проверить логи nginx
sudo tail -f /var/log/nginx/error.log
```

## Диагностика:

```bash
# 1. Проверить что порт 3002 слушается
netstat -tulpn | grep 3002
# Должно быть: LISTEN на 0.0.0.0:3002

# 2. Проверить что приложение отвечает
curl -v http://127.0.0.1:3002/api/public/payment-settings

# 3. Проверить логи PM2
pm2 logs bingo-admin --lines 100

# 4. Проверить переменные окружения
pm2 env bingo-admin | grep -E "PORT|NODE_ENV|DATABASE_URL"
```

