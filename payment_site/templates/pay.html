<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>–û–ø–ª–∞—Ç–∞ - Bingo KG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--tg-theme-bg-color, linear-gradient(135deg, #0a1a2e 0%, #16213e 25%, #1a237e 50%, #0d47a1 75%, #1565c0 100%));
            color: var(--tg-theme-text-color, #ffffff);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            background: var(--tg-theme-secondary-bg-color, rgba(15, 30, 60, 0.95));
            border-radius: 24px;
            padding: 32px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .header h1 {
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--tg-theme-button-color, #64b5f6);
            margin: 16px 0;
            text-shadow: 0 2px 10px rgba(100, 181, 246, 0.5);
        }
        
        .timer {
            text-align: center;
            margin: 16px 0;
            font-size: 20px;
            color: #e74c3c;
            font-weight: 600;
        }
        
        .block {
            background: transparent;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(100, 181, 246, 0.2);
            backdrop-filter: none;
        }
        
        .block-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--tg-theme-hint-color, #90caf9);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .qr-container {
            text-align: center;
        }
        
        .qr-code {
            max-width: 220px;
            width: 100%;
            margin: 0 auto;
            background: white;
            padding: 16px;
            border-radius: 12px;
        }
        
        .qr-code img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .bank-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .bank-button {
            padding: 16px 12px;
            border: 2px solid var(--tg-theme-hint-color, rgba(100, 181, 246, 0.3));
            border-radius: 16px;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            color: var(--tg-theme-text-color, #ffffff);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: none;
            min-height: 60px;
        }
        
        .bank-button:hover {
            border-color: var(--tg-theme-button-color, #64b5f6);
            background: rgba(100, 181, 246, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100, 181, 246, 0.4);
        }
        
        .bank-button.active {
            border-color: var(--tg-theme-button-color, #64b5f6);
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: var(--tg-theme-button-text-color, white);
            box-shadow: 0 6px 25px rgba(100, 181, 246, 0.6);
        }
        
        .warning {
            background: var(--tg-theme-secondary-bg-color, #fff3cd);
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 12px;
            margin: 16px 0;
            color: var(--tg-theme-hint-color, #856404);
            font-size: 13px;
        }
        
        .receipt-upload {
            margin-top: 20px;
        }
        
        .upload-area {
            border: 2px dashed var(--tg-theme-hint-color, rgba(100, 181, 246, 0.4));
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            backdrop-filter: none;
        }
        
        .upload-area:hover {
            border-color: var(--tg-theme-button-color, #64b5f6);
            background: rgba(100, 181, 246, 0.1);
            box-shadow: 0 4px 15px rgba(100, 181, 246, 0.2);
        }
        
        .upload-area.dragover {
            border-color: var(--tg-theme-button-color, #64b5f6);
            background: rgba(100, 181, 246, 0.15);
            box-shadow: 0 4px 20px rgba(100, 181, 246, 0.4);
        }
        
        .upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .upload-text {
            font-size: 14px;
            color: var(--tg-theme-text-color, #666);
            margin-bottom: 4px;
        }
        
        .upload-hint {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
        }
        
        .receipt-preview {
            margin-top: 12px;
            display: none;
        }
        
        .receipt-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 12px;
            border: 2px solid rgba(100, 181, 246, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .receipt-preview.show {
            display: block;
        }
        
        .remove-receipt {
            margin-top: 8px;
            padding: 6px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #666);
        }
        
        .button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.loading {
            position: relative;
            color: transparent;
        }
        
        .button.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 24px;
            }
            
            .amount {
                font-size: 28px;
            }
            
            .bank-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .bank-button {
                padding: 12px 8px;
                font-size: 12px;
                min-height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ –û–ø–ª–∞—Ç–∞</h1>
            <div class="amount" id="amount">{{ amount }} KGS</div>
            <div class="timer" id="timer">05:00</div>
        </div>
        
        <div class="block">
            <div class="block-title">QR –∫–æ–¥ –¥–ª—è –æ–ø–ª–∞—Ç—ã</div>
            <div class="qr-container" id="qrContainer">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ QR –∫–æ–¥–∞...</div>
            </div>
        </div>
        
        <div class="block">
            <div class="block-title">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫</div>
            <div class="bank-buttons" id="bankButtons">
                <!-- –ë–∞–Ω–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
        
        <div class="block receipt-upload">
            <div class="block-title">–§–æ—Ç–æ —á–µ–∫–∞ <span id="receiptRequired" style="color: #ef4444;">*</span></div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ</div>
                <div class="upload-hint" id="receiptHint">JPG, PNG –¥–æ 5MB. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã</div>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <div class="receipt-preview" id="receiptPreview">
                <img id="receiptImage" src="" alt="–ß–µ–∫">
                <button class="remove-receipt" onclick="removeReceipt()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
        
        <button class="button" id="paidButton" onclick="submitPayment()">
            ‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª
        </button>
    </div>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        let tg = window.Telegram?.WebApp;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram
        if (!tg || !tg.initDataUnsafe?.user) {
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            document.body.innerHTML = `
                <div style="
                    background: var(--tg-theme-bg-color, #ffffff);
                    color: var(--tg-theme-text-color, #000000);
                    padding: 40px 20px;
                    height: 100vh;
                    width: 100vw;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    text-align: center;
                ">
                    <img src="https://telegram.org/img/t_logo.png" alt="Telegram" style="width: 120px; height: 120px; margin-bottom: 20px;">
                    <p style="font-size: 18px; margin: 8px 0;"><strong>–£–ø—Å!</strong></p>
                    <p style="font-size: 18px; margin: 8px 0;">–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–æ <strong>–≤–Ω—É—Ç—Ä–∏ Telegram!</strong></p>
                </div>
            `;
        } else {
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            tg.expand(); // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤—Å–µ –æ–∫–Ω–æ
            tg.ready(); // –ì–æ–≤–æ—Ä–∏–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
        }
        
        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp
        function getUserId() {
            // –û—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±: initDataUnsafe.user.id
            if (tg?.initDataUnsafe?.user?.id) {
                const userId = tg.initDataUnsafe.user.id.toString();
                console.log('‚úÖ Got user ID from initDataUnsafe.user.id:', userId);
                return userId;
            }
            
            // Fallback: –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ)
            const urlParams = new URLSearchParams(window.location.search);
            const userIdFromUrl = urlParams.get('user_id');
            if (userIdFromUrl) {
                console.log('‚úÖ Got user ID from URL parameter:', userIdFromUrl);
                return userIdFromUrl;
            }
            
            console.warn('‚ö†Ô∏è Could not get user ID from Telegram WebApp');
            return null;
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let amount, requestId, expiresAt, telegramUserId, bankUrls, selectedBank, receiptFile;
        let casinoId, accountId, username, firstName, lastName;
        let paymentSettings = null;
        let requireReceiptPhoto = true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç—Ä–µ–±—É–µ—Ç—Å—è
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç Telegram)
        amount = parseFloat('{{ amount }}') || 0;
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º request_id: –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π –∏–ª–∏ 'None', —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        const requestIdRaw = '{{ request_id }}'.trim();
        requestId = (requestIdRaw && requestIdRaw !== 'None' && requestIdRaw !== 'null' && requestIdRaw !== 'undefined') ? requestIdRaw : '';
        expiresAt = parseInt('{{ expires_timestamp }}') || (Date.now() + 300000);
        telegramUserId = getUserId() || '{{ user_id }}' || '';
        casinoId = '{{ casino_id }}' || '';
        accountId = '{{ account_id }}' || '';
        username = '{{ username }}' || '';
        firstName = '{{ first_name }}' || '';
        lastName = '{{ last_name }}' || '';
        bankUrls = {};
        selectedBank = 'omoney';
        receiptFile = null;
        
        // –í—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –±–∞–Ω–∫–∏ (–±—É–¥—É—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º)
        const allBanks = [
            { id: 'omoney', name: 'O!Money' },
            { id: 'mbank', name: 'MBank' },
            { id: 'bakai', name: 'Bakai' },
            { id: 'demir', name: 'DemirBank' },
            { id: 'demirbank', name: 'DemirBank' }, // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
            { id: 'balance', name: 'Balance.kg' },
            { id: 'megapay', name: 'MegaPay' }
        ];
        
        // –ë–∞–Ω–∫–∏ (–±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
        let banks = [...allBanks];
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ API
        async function loadPaymentSettings() {
            try {
                const response = await fetch('https://fqxgmrzplndwsyvkeu.ru/api/public/payment-settings');
                const data = await response.json();
                
                if (data.success) {
                    paymentSettings = data;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ —á–µ–∫–∞
                    requireReceiptPhoto = data.require_receipt_photo !== false;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –±–ª–æ–∫–∞ —Å —á–µ–∫–æ–º
                    const receiptBlock = document.querySelector('.receipt-upload');
                    const receiptRequired = document.getElementById('receiptRequired');
                    const receiptHint = document.getElementById('receiptHint');
                    
                    if (receiptBlock) {
                        if (!requireReceiptPhoto) {
                            receiptBlock.style.display = 'none';
                        } else {
                            receiptBlock.style.display = 'block';
                        }
                    }
                    
                    if (receiptRequired) {
                        receiptRequired.style.display = requireReceiptPhoto ? 'inline' : 'none';
                    }
                    
                    if (receiptHint) {
                        receiptHint.textContent = requireReceiptPhoto 
                            ? 'JPG, PNG –¥–æ 5MB. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã'
                            : 'JPG, PNG –¥–æ 5MB. –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è';
                    }
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –±–∞–Ω–∫–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
                    const enabledBanks = data.deposits?.banks || [];
                    if (enabledBanks.length > 0) {
                        banks = allBanks.filter(bank => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ id –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏—è–º
                            return enabledBanks.includes(bank.id) || 
                                   (bank.id === 'demirbank' && enabledBanks.includes('demir')) ||
                                   (bank.id === 'demir' && enabledBanks.includes('demirbank'));
                        });
                        
                        // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã (demir –∏ demirbank)
                        const seen = new Set();
                        banks = banks.filter(bank => {
                            const key = bank.id === 'demir' || bank.id === 'demirbank' ? 'demir' : bank.id;
                            if (seen.has(key)) return false;
                            seen.add(key);
                            return true;
                        });
                        
                        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–∫ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
                        if (!banks.find(b => b.id === selectedBank || (b.id === 'demir' && selectedBank === 'demirbank') || (b.id === 'demirbank' && selectedBank === 'demir'))) {
                            selectedBank = banks[0]?.id || 'omoney';
                        }
                    }
                    
                    console.log('‚úÖ Payment settings loaded:', {
                        requireReceiptPhoto: requireReceiptPhoto,
                        enabledBanks: enabledBanks,
                        filteredBanks: banks.map(b => b.id)
                    });
                }
            } catch (error) {
                console.error('‚ùå Error loading payment settings:', error);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
        }
        
        console.log('üìä Payment Form Data:', {
            telegramUserId: telegramUserId,
            requestId: requestId,
            amount: amount,
            expiresAt: expiresAt,
            casinoId: casinoId,
            accountId: accountId,
            tgAvailable: !!tg,
            userAvailable: !!tg?.initDataUnsafe?.user
        });
        
        // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function updateTimer() {
            const now = Date.now();
            const remaining = expiresAt - now;
            
            if (remaining <= 0) {
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.textContent = '00:00';
                    timerEl.style.color = '#e74c3c';
                }
                // –¢–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫ - –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                if (tg) {
                    tg.showPopup({
                        title: '‚è∞ –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ',
                        message: '–í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –∏—Å—Ç–µ–∫–ª–æ. –§–æ—Ä–º–∞ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–∞.',
                        buttons: [{ 
                            type: 'ok',
                            text: '–û–ö'
                        }]
                    });
                    setTimeout(() => {
                        tg.close();
                    }, 2000);
                }
                return;
            }
            
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            const timerEl = document.getElementById('timer');
            if (timerEl) {
                timerEl.textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        setInterval(updateTimer, 1000);
        updateTimer();
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        async function loadQR() {
            try {
                console.log('üì§ Loading QR code for amount:', amount);
                
                // –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ API –∞–¥–º–∏–Ω–∫–∏
                let response;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);
                    
                    response = await fetch('https://fqxgmrzplndwsyvkeu.ru/api/public/generate-qr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            amount: amount,
                            bank: 'omoney' // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é O!Money
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    console.error('‚ùå Fetch error loading QR:', fetchError);
                    if (fetchError.name === 'AbortError') {
                        throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + fetchError.message);
                    }
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Response error loading QR:', response.status, errorText);
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}): ${errorText.substring(0, 100)}`);
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    console.error('‚ùå JSON parse error loading QR:', jsonError);
                    const text = await response.text();
                    throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${text.substring(0, 100)}`);
                }
                
                console.log('‚úÖ QR data received:', { success: data.success, has_urls: !!data.all_bank_urls });
                
                if (data.success) {
                    bankUrls = data.all_bank_urls || {};
                    
                    // –ë–µ—Ä–µ–º —Å—Å—ã–ª–∫—É O!Money –∏–∑ all_bank_urls
                    const omoneyUrl = bankUrls['omoney'] || bankUrls['O!Money'] || data.primary_url;
                    
                    if (omoneyUrl) {
                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ –∏–∑ —Å—Å—ã–ª–∫–∏ O!Money
                        generateQRImage(omoneyUrl);
                    } else {
                        console.error('‚ùå O!Money URL not found in response:', bankUrls);
                        document.getElementById('qrContainer').innerHTML = 
                            `<div class="loading" style="color: #e74c3c;">–û—à–∏–±–∫–∞: –°—Å—ã–ª–∫–∞ O!Money –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>`;
                    }
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –±–∞–Ω–∫–æ–≤
                    setupBankButtons();
                } else {
                    console.error('‚ùå QR generation failed:', data.error);
                    document.getElementById('qrContainer').innerHTML = 
                        `<div class="loading" style="color: #e74c3c;">–û—à–∏–±–∫–∞: ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥'}</div>`;
                }
            } catch (error) {
                console.error('‚ùå Error loading QR:', error);
                console.error('‚ùå Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                document.getElementById('qrContainer').innerHTML = 
                    `<div class="loading" style="color: #e74c3c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR –∫–æ–¥–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
            }
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Å—Å—ã–ª–∫–∏ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function generateQRImage(url) {
            const qrContainer = document.getElementById('qrContainer');
            if (!qrContainer) return;
            
            qrContainer.innerHTML = `
                <div class="qr-code">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}" alt="QR Code">
                </div>
                <p style="margin-top: 12px; color: #666; font-size: 13px;">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –¥–ª—è –æ–ø–ª–∞—Ç—ã</p>
            `;
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ –±–∞–Ω–∫–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function setupBankButtons() {
            const bankButtonsContainer = document.getElementById('bankButtons');
            if (!bankButtonsContainer) {
                console.warn('bankButtons container not found');
                return;
            }
            
            bankButtonsContainer.innerHTML = '';
            
            banks.forEach(bank => {
                const bankUrl = bankUrls[bank.id] || bankUrls[bank.name];
                const button = document.createElement('a');
                button.href = bankUrl || '#';
                button.target = '_blank';
                button.className = 'bank-button';
                if (bank.id === selectedBank) {
                    button.classList.add('active');
                }
                button.textContent = bank.name;
                
                if (bankUrl) {
                    button.onclick = (e) => {
                        e.preventDefault();
                        selectedBank = bank.id;
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                        document.querySelectorAll('.bank-button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        button.classList.add('active');
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
                        window.open(bankUrl, '_blank');
                    };
                } else {
                    // –ï—Å–ª–∏ URL –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π
                    button.style.opacity = '0.5';
                    button.style.cursor = 'wait';
                    button.onclick = (e) => {
                        e.preventDefault();
                    };
                }
                
                bankButtonsContainer.appendChild(button);
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ —á–µ–∫–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function initReceiptUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const receiptPreview = document.getElementById('receiptPreview');
            const receiptImage = document.getElementById('receiptImage');
            
            if (!uploadArea || !fileInput) return;
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                if (tg) {
                    tg.showPopup({
                        title: '–û—à–∏–±–∫–∞',
                        message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                }
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                if (tg) {
                    tg.showPopup({
                        title: '–û—à–∏–±–∫–∞',
                        message: '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 5MB',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 5MB');
                }
                return;
            }
            
            receiptFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                receiptImage.src = e.target.result;
                receiptPreview.classList.add('show');
            };
            reader.readAsDataURL(file);
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —á–µ–∫–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.removeReceipt = function() {
            receiptFile = null;
            const receiptImage = document.getElementById('receiptImage');
            const receiptPreview = document.getElementById('receiptPreview');
            const fileInput = document.getElementById('fileInput');
            
            if (receiptImage) receiptImage.src = '';
            if (receiptPreview) receiptPreview.classList.remove('show');
            if (fileInput) fileInput.value = '';
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ —Å —á–µ–∫–æ–º –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–Ø –æ–ø–ª–∞—Ç–∏–ª" (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.submitPayment = async function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram
            if (!tg || !tg.initDataUnsafe?.user) {
                if (tg) {
                    tg.showPopup({
                        title: '–û—à–∏–±–∫–∞',
                        message: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram');
                }
                return;
            }
            
            const paidButton = document.getElementById('paidButton');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
            if (!telegramUserId || !casinoId || !accountId) {
                if (tg) {
                    tg.showPopup({
                        title: '–û—à–∏–±–∫–∞',
                        message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏');
                }
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ —á–µ–∫–∞ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º)
            if (requireReceiptPhoto && !receiptFile) {
                if (tg) {
                    tg.showPopup({
                        title: '–í–Ω–∏–º–∞–Ω–∏–µ',
                        message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ —á–µ–∫–∞ –æ–± –æ–ø–ª–∞—Ç–µ. –≠—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞.',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ —á–µ–∫–∞ –æ–± –æ–ø–ª–∞—Ç–µ. –≠—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞.');
                }
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            paidButton.disabled = true;
            paidButton.classList.add('loading');
            
            try {
                let receiptBase64 = null;
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–æ—Ç–æ —á–µ–∫–∞ –≤ base64 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                if (receiptFile) {
                    const reader = new FileReader();
                    receiptBase64 = await new Promise((resolve, reject) => {
                        reader.onload = (e) => {
                            const base64 = e.target.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(receiptFile);
                    });
                }
                
                // –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (requestId), –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ requestId –Ω–µ –ø—É—Å—Ç–æ–π –∏ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º —á–∏—Å–ª–æ–º
                if (requestId && requestId.trim() !== '' && !isNaN(parseInt(requestId))) {
                    const updateData = {
                        id: parseInt(requestId)
                    };
                    
                    if (receiptBase64) {
                        updateData.receipt_photo = receiptBase64;
                    }
                    
                    if (telegramUserId) {
                        updateData.telegram_user_id = telegramUserId;
                    }
                    
                    console.log('üì§ Updating existing request:', {
                        id: updateData.id,
                        has_receipt: !!updateData.receipt_photo
                    });
                    
                    let response;
                    try {
                        // –°–æ–∑–¥–∞–µ–º AbortController –¥–ª—è —Ç–∞–π–º–∞—É—Ç–∞
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                        
                        response = await fetch('https://fqxgmrzplndwsyvkeu.ru/api/payment', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updateData),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                    } catch (fetchError) {
                        console.error('‚ùå Fetch error:', fetchError);
                        if (fetchError.name === 'AbortError') {
                            throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        } else if (fetchError.message && fetchError.message.includes('Failed to fetch')) {
                            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        } else {
                            throw new Error(fetchError.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        }
                    }
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Response error:', response.status, errorText);
                        throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}): ${errorText.substring(0, 100)}`);
                    }
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (jsonError) {
                        console.error('‚ùå JSON parse error:', jsonError);
                        const text = await response.text();
                        throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${text.substring(0, 100)}`);
                    }
                    
                    if (data.success) {
                        if (tg) {
                            tg.showPopup({
                                title: '‚úÖ –£—Å–ø–µ—à–Ω–æ',
                                message: '–ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.',
                                buttons: [{ 
                                    type: 'ok',
                                    text: '–û–ö'
                                }]
                            });
                            
                            setTimeout(() => {
                                tg.close();
                            }, 1500);
                        } else {
                            alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
                        }
                    } else {
                        throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞—è–≤–∫—É');
                    }
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
                    const requestData = {
                        telegram_user_id: telegramUserId,
                        type: 'deposit',
                        amount: amount,
                        bookmaker: casinoId,
                        account_id: accountId,
                        telegram_username: username || null,
                        telegram_first_name: firstName || null,
                        telegram_last_name: lastName || null
                    };
                    
                    if (receiptBase64) {
                        requestData.receipt_photo = receiptBase64;
                    }
                    
                    console.log('üì§ Creating new request:', {
                        telegram_user_id: requestData.telegram_user_id,
                        amount: requestData.amount,
                        bookmaker: requestData.bookmaker,
                        account_id: requestData.account_id,
                        has_receipt: !!requestData.receipt_photo
                    });
                    
                    let response;
                    try {
                        // –°–æ–∑–¥–∞–µ–º AbortController –¥–ª—è —Ç–∞–π–º–∞—É—Ç–∞
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                        
                        response = await fetch('https://fqxgmrzplndwsyvkeu.ru/api/payment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestData),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                    } catch (fetchError) {
                        console.error('‚ùå Fetch error:', fetchError);
                        if (fetchError.name === 'AbortError') {
                            throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        } else if (fetchError.message && fetchError.message.includes('Failed to fetch')) {
                            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        } else {
                            throw new Error(fetchError.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        }
                    }
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Response error:', response.status, errorText);
                        throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}): ${errorText.substring(0, 100)}`);
                    }
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (jsonError) {
                        console.error('‚ùå JSON parse error:', jsonError);
                        const text = await response.text();
                        throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${text.substring(0, 100)}`);
                    }
                    
                    if (data.success) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏
                        requestId = data.data?.id || data.data?.transactionId;
                        
                        if (tg) {
                            tg.showPopup({
                                title: '‚úÖ –£—Å–ø–µ—à–Ω–æ',
                                message: '–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.',
                                buttons: [{ 
                                    type: 'ok',
                                    text: '–û–ö'
                                }]
                            });
                            
                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –±–æ—Ç–∞
                            setTimeout(() => {
                                tg.close();
                            }, 1500);
                        } else {
                            alert('‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
                        }
                    } else {
                        throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error submitting payment:', error);
                console.error('‚ùå Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    type: typeof error
                });
                
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                paidButton.disabled = false;
                paidButton.classList.remove('loading');
                
                let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.name === 'TypeError' && error.message && error.message.includes('fetch')) {
                    errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                }
                
                if (tg) {
                    tg.showPopup({
                        title: '–û—à–∏–±–∫–∞',
                        message: errorMessage,
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + errorMessage);
                }
            }
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (tg && tg.initDataUnsafe?.user) {
            console.log('‚úÖ Telegram WebApp initialized');
        } else {
            console.warn('‚ö†Ô∏è Not in Telegram WebApp, but continuing anyway');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç Telegram)
        initReceiptUpload();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∑–∞—Ç–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ
        loadPaymentSettings().then(() => {
            setupBankButtons(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            loadQR(); // –ó–∞–≥—Ä—É–∂–∞–µ–º QR –∫–æ–¥
        }).catch((error) => {
            console.error('‚ùå Error initializing payment form:', error);
            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            setupBankButtons();
            loadQR();
        });
    </script>
</body>
</html>
